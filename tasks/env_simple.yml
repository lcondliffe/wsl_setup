- name: Write system-wide exported environment variables
  become: true
  ansible.builtin.copy:
    dest: /etc/profile.d/99-custom-env.sh
    owner: root
    group: root
    mode: "0644"
    content: |
      #!/bin/sh
      # Managed by Ansible: system-wide environment variables
      {% for k, v in env_vars.items() %}
      export {{ k }}="{{ v }}"
      {% endfor %}
  tags: [env]

- name: Ensure .zshrc contains exported env vars (and PATH updates)
  ansible.builtin.blockinfile:
    path: "{{ ansible_env.HOME }}/.zshrc"
    create: true
    marker: "# {mark} ANSIBLE MANAGED BLOCK: Exported env vars"
    block: |
      # Managed by Ansible: exported env vars
      {% for k, v in env_vars.items() %}
      export {{ k }}="{{ v }}"
      {% endfor %}
      # If KREW_PATH is set, ensure it's on PATH
      if [ -n "${KREW_PATH:-}" ]; then
        export PATH="$KREW_PATH:$PATH"
      fi
  tags: [env, shell]
