---
- name: WSL Ubuntu setup
  hosts: localhost
  connection: local
  gather_facts: true
  vars_files:
    - vars.yml

  variables:
    run_bootstrap_scripts: false
    ansible_python_interpreter: /usr/bin/python3

  tasks:
    - name: Ensure base directories exist in HOME
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        mode: "0755"
      loop: "{{ directories }}"
      tags: [dirs]

    - name: Export environment variables system-wide
      ansible.builtin.include_tasks: tasks/env_simple.yml
      tags: [env]

    - name: apt repositories
      ansible.builtin.include_tasks: tasks/apt_repos.yml
      tags: [apt]

    - name: Update apt cache
      become: true
      ansible.builtin.apt:
        update_cache: true
      tags: [apt]

    - name: Install apt packages
      become: true
      ansible.builtin.apt:
        name: "{{ apt_packages }}"
        state: present
      tags: [apt]

    - name: Ensure /etc/shells includes zsh
      become: true
      ansible.builtin.lineinfile:
        path: /etc/shells
        line: /usr/bin/zsh
        state: present
        create: no
      tags: [zsh, shell]

    - name: Set zsh as default shell for current user
      become: true
      ansible.builtin.user:
        name: "{{ ansible_user_id }}"
        shell: /usr/bin/zsh
      tags: [zsh, shell]

    - name: Ensure .zshrc contains a managed block for custom aliases
      ansible.builtin.blockinfile:
        path: "{{ ansible_env.HOME }}/.zshrc"
        create: true
        marker: "# {mark} ANSIBLE MANAGED BLOCK: Custom Aliases"
        block: |
          {% for alias_name, alias_command in shell_aliases.items() %}
          alias {{ alias_name }}="{{ alias_command }}"
          {% endfor %}
      tags: [aliases, shell]

    - name: Terraform
      ansible.builtin.include_tasks: tasks/terraform.yml
      tags: [terraform, scripts]

    - name: Infracost
      ansible.builtin.include_tasks: tasks/infracost.yml
      tags: [infracost, scripts]

    - name: Kubectl
      ansible.builtin.include_tasks: tasks/kubectl.yml
      tags: [kubectl, scripts]

    - name: Helm
      ansible.builtin.include_tasks: tasks/helm.yml
      tags: [helm, scripts]
